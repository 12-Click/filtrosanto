<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saint Francis Xavier AR Face Filter</title>
    <style>
        body { margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #video, #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #halo { position: absolute; width: 200px; opacity: 0.8; pointer-events: none; }
        #capture-button { position: fixed; bottom: 20px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <!-- Video and Canvas Elements -->
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>

    <!-- Halo Image for Overlay -->
    <img id="halo" src="images/angel.png" alt="Halo Overlay" style="display:none;">

    <!-- Capture Button -->
    <button id="capture-button">Capture</button>

    <!-- Face Detection and Rendering Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

    <script>
        async function startAR() {
            // Load Face Detection Models from Hosted URLs
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');

            // Start Video
            const video = document.getElementById('video');
            const halo = document.getElementById('halo');
            const constraints = {
                video: {
                    facingMode: "user",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(err => console.error("Error accessing camera: ", err));

            video.addEventListener('loadeddata', () => {
                const canvas = faceapi.createCanvasFromMedia(video);
                document.body.append(canvas);
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);

                // Detect Face and Adjust Overlay Position
                setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    if (detections.length > 0) {
                        const { box } = detections[0].detection;
                        halo.style.display = 'block';
                        // Center the halo horizontally over the face
                        halo.style.top = ${box.top - 100}px;
                        halo.style.left = ${box.left + box.width / 2 - 100}px;
                    } else {
                        halo.style.display = 'none'; // Hide halo if no face is detected
                    }
                }, 100);
            });
        }

        function captureImage() {
            // Create a temporary canvas to capture the video and overlay
            const video = document.getElementById('video');
            const halo = document.getElementById('halo');
            const captureCanvas = document.createElement('canvas');
            const context = captureCanvas.getContext('2d');

            // Set the canvas dimensions to match the video
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;

            // Draw the video frame
            context.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);

            // Draw the halo image at its current position
            if (halo.style.display !== 'none') {
                const haloX = parseFloat(halo.style.left);
                const haloY = parseFloat(halo.style.top);
                context.drawImage(halo, haloX, haloY, halo.width, halo.height);
            }

            // Convert the canvas to an image and download it
            const image = captureCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = 'captured_image.png';
            link.click();
        }

        document.getElementById('capture-button').addEventListener('click', captureImage);

        startAR();
    </script>
</body>
</html>
